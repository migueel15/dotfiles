#!/usr/bin/env bash
set -euo pipefail

# Definir DOTFILES_DIR como la carpeta raíz (un nivel arriba de bin/)
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Importar logger y funciones comunes
source "$DOTFILES_DIR/core/logger"
# source "$DOTFILES_DIR/core/utils"
source "$DOTFILES_DIR/core/package"
source "$DOTFILES_DIR/core/initial_setup"

print_help() {
  cat <<EOF
Uso: dotfiles <comando> [opciones]

Comandos:
  list                Listar módulos disponibles
  status              Revisar estado del entorno
  install <modulo>    Instalar un módulo (apps + todos si no se especifica)
  generate <modulo>   Crear un módulo nuevo
  setup [--env]       Instalar dependencias del CLI y Bitwarden
  help                Mostrar esta ayuda
EOF
}

list_modules() {
  log_title "Módulos disponibles:"
  for mod in "$DOTFILES_DIR/modules"/*; do
    if [[ -d "$mod" ]]; then
      local mod_name
      local deps_status
      local setup_status
      local config_status

      mod_name=$(basename "$mod")
      deps_status="no"
      setup_status="no"
      config_status="no"

      [[ -s "$mod/deps" ]] && deps_status="yes"
      [[ -x "$mod/setup" ]] && setup_status="yes"
      [[ -d "$mod/config" ]] && config_status="yes"

      printf "  %-16s deps:%-3s setup:%-3s config:%-3s\n" "$mod_name" "$deps_status" "$setup_status" "$config_status"
    fi
  done
}

install_deps_from_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    log_info "Instalando dependencias desde $file"
    install_packages_from_deps "$file"  # Función en core/package
  else
    log_warn "No existe el archivo $file"
  fi
}

update_yay_repo() {
  log_info "Actualizando repositorios de yay..."
  yay -Syy --noconfirm
}

install_cli_deps() {
  log_title "Instalando dependencias del CLI..."
  install_deps_from_file "$DOTFILES_DIR/packages/deps"
}

install_apps() {
  log_title "Instalando apps globales..."
  install_deps_from_file "$DOTFILES_DIR/packages/apps"
}

install_module() {
  local mod="$1"
  local mod_dir="$DOTFILES_DIR/modules/$mod"

  if [[ ! -d "$mod_dir" ]]; then
    log_error "El módulo '$mod' no existe."
    exit 1
  fi

  log_title "Instalando módulo '$mod'..."

  install_deps_from_file "$mod_dir/deps"

  if [[ -x "$mod_dir/setup" ]]; then
    log_info "Ejecutando setup del módulo..."
    export DOTFILES_DIR=$DOTFILES_DIR
    export CONFIG_DIR="$mod_dir/config"
    (cd "$mod_dir" && ./setup)
  else
    log_warn "No se encontró un setup ejecutable para '$mod'"
  fi

  log_success "Módulo '$mod' instalado."
}

install_all_modules() {
  for mod_path in "$DOTFILES_DIR/modules"/*; do
    if [[ -d "$mod_path" ]]; then
      install_module "$(basename "$mod_path")"
    fi
  done
}

status_report() {
  log_title "Estado del entorno:"

  if check_command yay; then
    log_success "yay disponible"
  else
    log_error "yay no está instalado"
  fi

  if check_command jq; then
    log_success "jq disponible"
  else
    log_error "jq no está instalado"
  fi

  if check_command bw; then
    local bw_status
    bw_status=$(bw status 2>/dev/null | jq -r '.status' 2>/dev/null || echo "unknown")
    case "$bw_status" in
      unauthenticated)
        log_warn "Bitwarden: sin sesión"
        ;;
      locked)
        log_warn "Bitwarden: bloqueado"
        ;;
      unlocked)
        log_success "Bitwarden: desbloqueado"
        ;;
      *)
        log_warn "Bitwarden: estado desconocido"
        ;;
    esac
  else
    log_error "Bitwarden CLI no está instalado"
  fi

  local missing_setup=()
  for mod_path in "$DOTFILES_DIR/modules"/*; do
    if [[ -d "$mod_path" && ! -x "$mod_path/setup" ]]; then
      missing_setup+=("$(basename "$mod_path")")
    fi
  done

  if [[ ${#missing_setup[@]} -gt 0 ]]; then
    log_warn "Módulos sin setup ejecutable: ${missing_setup[*]}"
  else
    log_success "Todos los módulos tienen setup ejecutable"
  fi
}

generate_module() {
  local mod="$1"
  local mod_dir="$DOTFILES_DIR/modules/$mod"

  if [[ -d "$mod_dir" ]]; then
    log_warn "El módulo '$mod' ya existe en $mod_dir"
    return 1
  fi

  mkdir -p "$mod_dir/config"
  touch "$mod_dir/deps"
  cat > "$mod_dir/setup" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
source $DOTFILES_DIR/core/logger # log_info log_error log_success log_title log_warn

# Script setup básico para módulo
EOF

  chmod +x "$mod_dir/setup"

  log_success "Módulo '$mod' creado en $mod_dir con estructura básica."
}


main() {
  if [[ $# -lt 1 ]]; then
    print_help
    exit 0
  fi

  case "$1" in
    list)
      list_modules
      ;;
    status)
      status_report
      ;;
    install)
      if [[ $# -eq 1 ]]; then
        install_apps
        install_all_modules
      else
        install_module "$2"
      fi
      ;;
    generate)
      if [[ $# -lt 2 ]]; then
        log_error "Debes especificar el nombre del módulo a generar."
        exit 1
      fi
      generate_module "$2"
      ;;
    setup)
      if [[ ${2:-} == "--env" ]]; then
        exec 3>&1
        exec 1>&2
        initial_setup_yay
        update_yay_repo
        install_cli_deps
        setup_bw
        exec 1>&3
        exec 3>&-

        if [[ -z "${BW_SESSION:-}" && -s "$HOME/.bw_session" ]]; then
          BW_SESSION=$(<"$HOME/.bw_session")
        fi

        if [[ -n "${BW_SESSION:-}" ]]; then
          printf 'export BW_SESSION=%q\n' "$BW_SESSION"
        else
          log_error "No se pudo obtener BW_SESSION"
          exit 1
        fi
      else
        initial_setup_yay
        update_yay_repo
        install_cli_deps
        setup_bw
      fi
      ;;
    help|--help|-h)
      print_help
      ;;
    *)
      log_error "Comando desconocido: $1"
      print_help
      exit 1
      ;;
  esac
}

main "$@"
